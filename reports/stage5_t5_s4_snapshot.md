# Owlume — Stage 5 • T5-S4 Mini UX Demo Snapshot
**Date:** 2025-10-30  
**Owner:** Brian (with Ted)  
**Scope:** Local simulation of the Agent loop + Nudge Cards → Clarity Card generation

---

## 1) Summary
T5-S4 is operational. The Agent watches for insight events, renders **Nudge Cards**, simulates user actions, and on `SHARE_CARD` generates Markdown **Clarity Cards**. Watch-mode added to auto-run on file changes.

**Outcome:** Demo loop works end-to-end on local machine.

---

## 2) What changed (code + config)
- `src/agent/t5_s4_agent_loop.py` — Agent loop (templates → nudge cards → simulated clicks → SHARE_CARD → clarity card)
- `src/ui_utils_nudge.py` — Lightweight HTML renderer for Nudge Cards (CSS brace escaping fixed)
- `data/nudges/nudge_templates.json` — Template config with `POST_SESSION_BOOST` (includes `SHARE_CARD`)
- `scripts/t5_s4_agent_loop_sim.py` — CLI driver (runs hook → agent)
- `scripts/t5_s4_watch_agent.py` — **Watch mode** to auto-run Agent on changes (events/templates; debounced)
- (Hardening) Events reader uses `utf-8-sig` to avoid BOM issues on Windows

**Commit:** `T5-S4: Mini UX Demo — agent loop + nudge cards + SHARE_CARD → Clarity Card (full-record lookup, BOM-safe)`

---

## 3) How to run (quick)
**One-off:**
```bash
python -u -m src.agent.t5_s4_agent_loop

Watch mode (auto-rerun on change):
python -u scripts/t5_s4_watch_agent.py

Seed demo events (PowerShell, Windows PowerShell 5.1):
$path = "data/runtime/insight_events.jsonl"
$content = @'
{"type":"HIGH_CG_SESSION","did":"DID-2025-0012","mode":"Assumption","principle":"Evidence","cg_delta":0.36}
{"type":"HIGH_CG_SESSION","did":"DID-2025-0014","mode":"Decision","principle":"Risk","cg_delta":0.50}
'@
[IO.File]::WriteAllText($path, $content, (New-Object System.Text.UTF8Encoding($false)))

4) Artifacts produced

reports/nudge_cards_demo.html — Nudge Cards (rendered)

reports/clarity_cards/clarity_card_<DID>.md — Clarity Cards generated by SHARE_CARD

data/runtime/insight_events.jsonl — Agent input (HIGH/LOW CG events)

data/runtime/user_responses.jsonl — Simulated user actions (includes artifact paths)

5) Demo proof (expected console)
[T5-S4] rendered 2 card(s) → reports\nudge_cards_demo.html
[T5-S4] SHARE_CARD → wrote reports\clarity_cards\clarity_card_DID-2025-0012.md
[T5-S4] SHARE_CARD → wrote reports\clarity_cards\clarity_card_DID-2025-0014.md
[T5-S4] logged 2 user action(s) → data\runtime\user_responses.jsonl

6) QA checklist

 At least one Nudge Card renders from seeded events

 user_responses.jsonl logs one action per card

 SHARE_CARD produces a new Clarity Card .md

 Watcher re-runs on events or template edits

 No BOM/encoding errors on Windows (utf-8-sig read)

 No UTC warnings (datetime.now(timezone.utc))

7) Known limitations / notes

Templates currently match on a simple when: "event.type == '…'".

render_template_str uses Jinja2; can be swapped to stdlib placeholder fn if avoiding deps.

Full-record lookup for SHARE_CARD uses data/logs/clarity_gain_samples.jsonl by did; if missing, falls back to a minimal stub.

t5_s4_agent_loop_sim.py can optionally skip regenerating events if file is already populated.

8) Next up

T5-S5 — Runtime Core (Live UX Embed)

Wire real user input → engine → event emission (no seeding).

Add LOW_CG_SESSION template & probe action (unstick flows).

Optional: Auto-open rendered nudge_cards_demo.html post-run on Windows.

T5-S6 — Feedback Bridge

Persist action telemetry + clarity outcomes to DilemmaNet (loop closure).

Add dedupe/run-marker to prevent double logs under rapid file saves.

9) Appendix — Paths reference
data/nudges/nudge_templates.json
data/runtime/insight_events.jsonl
data/runtime/user_responses.jsonl
reports/nudge_cards_demo.html
reports/clarity_cards/clarity_card_<DID>.md
